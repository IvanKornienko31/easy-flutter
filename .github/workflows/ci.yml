name: CI Pipeline

on:
  push:
    branches: ['main', 'master']
  pull_request:
    branches: ['main', 'master']

jobs:
  quality-check:
    name: üõ°Ô∏è Quality & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: üé® Linting (ESLint & Prettier)
        run: bun run lint

      - name: üìê Type Checking (Svelte-Check)
        run: bun run check

      - name: üß™ Unit Testing (Vitest)
        run: bun run test

      - name: üèóÔ∏è Build Verification
        run: bun run build

  lighthouse:
    name: üí° Lighthouse Audit
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build App
        run: bun run build

      - name: Start Server
        run: bun run preview &

      - name: Run Lighthouse CI
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π —ç–∫—à–µ–Ω –¥–ª—è –∞—É–¥–∏—Ç–∞
        uses: treosh/lighthouse-ci-action@v11
        with:
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–∞–ø–∫–µ –±–∏–ª–¥–∞ (Vercel adapter —Å–æ–∑–¥–∞–µ—Ç .vercel/output, –Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—â–µ preview)
          # –í–Ω–∏–º–∞–Ω–∏–µ: –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ Lighthouse –≤ CI –Ω–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã vite preview —Ä–∞–±–æ—Ç–∞–ª
          urls: 'http://localhost:4173/'
          startServerCommand: 'bun run preview'
          # –ñ–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è
          serverWaitTimeout: 10000
          uploadArtifacts: true
          temporaryPublicStorage: true
          # –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∂–µ—Å—Ç—á–µ)
          budgetPath: .github/lighthouse-budget.json
